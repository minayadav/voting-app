name: Deploy to Local Docker Desktop

on:
  push:
    branches: 
      - main
  workflow_dispatch:  # Manual trigger option

jobs:
  deploy-to-local:
    name: Deploy to Local Docker Desktop
    runs-on: self-hosted  # This will run on YOUR computer!
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Verify Docker is running
        run: |
          docker --version
          docker ps
      
      - name: ğŸ›‘ Stop existing containers
        run: |
          docker-compose down
        continue-on-error: true
      
      - name: ğŸ§¹ Clean up old images (optional)
        run: |
          docker system prune -f
        continue-on-error: true
      
      - name: ğŸ—ï¸ Build Docker images
        run: |
          docker-compose build --no-cache
      
      - name: ğŸš€ Start containers
        run: |
          docker-compose up -d
      
      - name: â³ Wait for services to be ready
        run: |
          Start-Sleep -Seconds 30
      
      - name: ğŸ¥ Health check - Voting App
        run: |
          $maxAttempts = 5
          $attempt = 0
          $success = $false
          
          while ($attempt -lt $maxAttempts -and -not $success) {
            try {
              $response = Invoke-WebRequest -Uri http://localhost:5000/health -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                $success = $true
                Write-Host "âœ… Voting app is healthy"
              }
            } catch {
              $attempt++
              Write-Host "Attempt $attempt failed, retrying..."
              Start-Sleep -Seconds 5
            }
          }
          
          if (-not $success) {
            Write-Error "Voting app health check failed after $maxAttempts attempts"
            exit 1
          }
      
      - name: ğŸ¥ Health check - Result App
        run: |
          $maxAttempts = 5
          $attempt = 0
          $success = $false
          
          while ($attempt -lt $maxAttempts -and -not $success) {
            try {
              $response = Invoke-WebRequest -Uri http://localhost:5001/health -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                $success = $true
                Write-Host "âœ… Result app is healthy"
              }
            } catch {
              $attempt++
              Write-Host "Attempt $attempt failed, retrying..."
              Start-Sleep -Seconds 5
            }
          }
          
          if (-not $success) {
            Write-Error "Result app health check failed after $maxAttempts attempts"
            exit 1
          }
      
      - name: ğŸ“Š Show running containers
        run: |
          docker-compose ps
      
      - name: ğŸ“ Show deployment info
        run: |
          Write-Host "========================================="
          Write-Host "âœ… Deployment Completed Successfully!"
          Write-Host "========================================="
          Write-Host ""
          Write-Host "ğŸŒ Access your application:"
          Write-Host "   Voting App:  http://localhost:5000"
          Write-Host "   Result App:  http://localhost:5001"
          Write-Host ""
          Write-Host "ğŸ“Š Container Status:"
          docker-compose ps
          Write-Host ""
          Write-Host "ğŸ“ Recent logs:"
          docker-compose logs --tail=10
      
      - name: ğŸ‰ Deployment notification
        run: |
          Write-Host "ğŸ‰ Your voting app is now running on your local Docker Desktop!"
          Write-Host "Deployed from commit: ${{ github.sha }}"
          Write-Host "Deployed by: ${{ github.actor }}"